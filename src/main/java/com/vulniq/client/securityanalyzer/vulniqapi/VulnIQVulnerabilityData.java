
/*
 *     VulnIQ Security Scanner, Terzi
 *     Copyright (C) 2021  SBOSoft A.S. and its affiliates
 *     Contact : info@vulniq.com www.vulniq.com
 *
 *     This program is free software: you can redistribute it and/or modify
 *     it under the terms of the GNU General Public License as published by
 *     the Free Software Foundation, either version 3 of the License, or
 *     (at your option) any later version.
 *
 *     This program is distributed in the hope that it will be useful,
 *     but WITHOUT ANY WARRANTY; without even the implied warranty of
 *     MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *     GNU General Public License for more details.
 *
 *     You should have received a copy of the GNU General Public License
 *     along with this program.  If not, see <https://www.gnu.org/licenses/>.
 */

package com.vulniq.client.securityanalyzer.vulniqapi;

import com.google.gson.JsonObject;
import com.vulniq.client.securityanalyzer.scan.finding.ScanFinding;
import com.vulniq.client.securityanalyzer.utils.DateTimeUtils;
import com.vulniq.client.securityanalyzer.utils.JSONUtils;
import com.vulniq.client.securityanalyzer.utils.StringUtils;

import java.util.Date;
import java.util.LinkedList;
import java.util.List;

/**
 * A vulnerability data from VulnIQ
 */
public class VulnIQVulnerabilityData
{
    private int dataType;
    private String guid;
    private String name;
    private String description;
    private String dataCategory;
    private String dataScore;
    private boolean exploitExists;
    private boolean fixExists;
    private Date createDateAtSource;
    private Date lastUpdatedAtSource;


    public VulnIQVulnerabilityData(JsonObject vulnValueFromListByPackage)
    {
        this.guid = JSONUtils.getAsString(vulnValueFromListByPackage, "guid");
        this.dataType = StringUtils.parseInt(JSONUtils.getAsString(vulnValueFromListByPackage, "dataType"), 0);
        this.name = JSONUtils.getAsString(vulnValueFromListByPackage, "name");
        this.description = JSONUtils.getAsString(vulnValueFromListByPackage, "description");
        this.dataCategory = JSONUtils.getAsString(vulnValueFromListByPackage, "dataCategory");
        this.dataScore = JSONUtils.getAsString(vulnValueFromListByPackage, "dataScore");
        this.exploitExists = StringUtils.parseInt(JSONUtils.getAsString(vulnValueFromListByPackage, "exploitExists"), 0)>0;
        this.fixExists = StringUtils.parseInt(JSONUtils.getAsString(vulnValueFromListByPackage, "fixExists"), 0) > 0;
        this.createDateAtSource = DateTimeUtils.parseDateTime(JSONUtils.getAsString(vulnValueFromListByPackage, "createDateAtSource"));
        this.lastUpdatedAtSource = DateTimeUtils.parseDateTime(JSONUtils.getAsString(vulnValueFromListByPackage, "lastUpdatedAtSource"));
    }

    /**
     * Used only for responses from vulnIQVulnsByVendorProductUrl, for Microsoft products only
     * @param vulnValueFromListByVendorProduct
     * @param vendorName
     */
    public VulnIQVulnerabilityData(JsonObject vulnValueFromListByVendorProduct, String vendorName)
    {
        this(vulnValueFromListByVendorProduct);
        if(this.dataType<1)
        {
            //TODO this should not be necessary
            this.dataType = VulnIQConstants.VIQ_DataType_MS_CVE;
        }
        if(this.guid == null || this.guid.isBlank())
        {
            this.guid = "MS-" + JSONUtils.getAsString(vulnValueFromListByVendorProduct, "cveId");
        }
        if(this.name == null || this.name.isBlank())
        {
            this.name = this.getGuid();
        }
        if(this.getCreateDateAtSource()==null)
        {
            this.createDateAtSource = DateTimeUtils.parseDateTime(JSONUtils.getAsString(vulnValueFromListByVendorProduct, "initialReleaseDate"));
        }
        if(this.getLastUpdatedAtSource()==null)
        {
            this.lastUpdatedAtSource = DateTimeUtils.parseDateTime(JSONUtils.getAsString(vulnValueFromListByVendorProduct, "releaseDate"));
        }
        String severity = JSONUtils.getAsString(vulnValueFromListByVendorProduct, "severity");
        String impact = JSONUtils.getAsString(vulnValueFromListByVendorProduct, "impact");
        String cvssVectorString = JSONUtils.getAsString(vulnValueFromListByVendorProduct, "vectorString");
        if(this.getDataScore()==null || this.getDataScore().isBlank())
        {
            if(severity!=null && !severity.isBlank())
            {
                if("Important".equals(severity))
                {
                    this.setDataScore("High");
                }
                else if("Critical".equals(severity))
                {
                    this.setDataScore("Critical");
                }
                else
                {
                    //TODO improve
                    this.setDataScore("Medium");
                }
            }
        }

        StringBuilder descriptionBuilder = new StringBuilder();
        if(this.description!=null && !this.description.isEmpty())
        {
            descriptionBuilder.append(this.description);
            descriptionBuilder.append("\n");
        }
        if(severity!=null && !severity.isBlank())
        {
            descriptionBuilder.append("Severity: ");
            descriptionBuilder.append(severity);
            descriptionBuilder.append("\n");
        }
        if(impact!=null && !impact.isBlank())
        {
            descriptionBuilder.append("Impact: ");
            descriptionBuilder.append(impact);
            descriptionBuilder.append("\n");
        }
        if(cvssVectorString!=null && !cvssVectorString.isBlank())
        {
            descriptionBuilder.append("CVSS: ");
            descriptionBuilder.append(cvssVectorString);
            descriptionBuilder.append("\n");
        }
        if(vulnValueFromListByVendorProduct.has("productName"))
        {
            descriptionBuilder.append("Product: ");
            descriptionBuilder.append(JSONUtils.getAsString(vulnValueFromListByVendorProduct, "productName"));
            descriptionBuilder.append("\n");
        }
        this.description = descriptionBuilder.toString();
    }

    @Override
    public String toString()
    {
        return guid;
    }

    public String getGuid()
    {
        return guid;
    }

    public void setGuid(String guid)
    {
        this.guid = guid;
    }

    public String getName()
    {
        return name;
    }

    public void setName(String name)
    {
        this.name = name;
    }

    public String getDescription()
    {
        return description;
    }

    public void setDescription(String description)
    {
        this.description = description;
    }

    public int getDataType()
    {
        return dataType;
    }

    public void setDataType(int dataType)
    {
        this.dataType = dataType;
    }

    public String getDataCategory()
    {
        return dataCategory;
    }

    public void setDataCategory(String dataCategory)
    {
        this.dataCategory = dataCategory;
    }

    public String getDataScore()
    {
        return dataScore;
    }

    public void setDataScore(String dataScore)
    {
        this.dataScore = dataScore;
    }

    public boolean isExploitExists()
    {
        return exploitExists;
    }

    public void setExploitExists(boolean exploitExists)
    {
        this.exploitExists = exploitExists;
    }

    public boolean isFixExists()
    {
        return fixExists;
    }

    public void setFixExists(boolean fixExists)
    {
        this.fixExists = fixExists;
    }

    public Date getCreateDateAtSource()
    {
        return createDateAtSource;
    }

    public void setCreateDateAtSource(Date createDateAtSource)
    {
        this.createDateAtSource = createDateAtSource;
    }

    public Date getLastUpdatedAtSource()
    {
        return lastUpdatedAtSource;
    }

    public void setLastUpdatedAtSource(Date lastUpdatedAtSource)
    {
        this.lastUpdatedAtSource = lastUpdatedAtSource;
    }

}
